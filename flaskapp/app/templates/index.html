
<html>
<head>
 <!-- The below link for Google Fonts was sourced from https://www.w3schools.com/howto/howto_google_fonts.asp-->
<link href='https://fonts.googleapis.com/css?family=Open%20Sans' rel='stylesheet'>
<title>{{ Title }}</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/styling.css') }}">
<script src = "http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.6.2.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
</head>
    
<script type="text/javascript">
$(window).load(function() {
    $(".loader").fadeOut("slow");
});
</script>
    
<body>
<div class="loader"></div> 

<!--The Map-->
<div id="map"></div>
<div id="legend"><h3>Legend</h3></div>
<div id="legend2"></div>

<div class = "centredetail">
    <div class = "minorinfo">
        <a class="twitter-timeline"  href="https://twitter.com/hashtag/DublinBikes" data-height = "205" data-widget-id="985166481745948673">#DublinBikes Tweets</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>  
    </div>
    <div class = "minorinfo">
        <h2>Dublin Bikes App</h2>
        <p>Welcome to the Dublin Bikes app! Here you can find live data and historical usage trends to better plan your trips<br>
        Please select a marker above or use the dropdowns below</p>
    </div>
    <div class = "minorinfo">
        <div>
            <h3 id="weather"></h3>
            <p id= "temp"></p>
            <p id= "humidity"></p>
            <p id= "wind"></p>
        </div>
    </div>
</div>
    
<div class = "centredetail">    
<!--Weekly Chart-->
<div id = "chart" >
    <div id="chartdiv"></div>
    <div id="curtain"><span>Chart Loads Here</span></div>
</div>  
<!--The Dropdowns  -->
<div id="dropdownHolder">
<div id="dds">
<select id="myDropdown" onchange = "insertAddInfo(value); resetDropdown()"></select>    
<select id="dayOfWeek" onchange="insertAddHourlyInfo(value)" >
        <option value="" selected disabled hidden>Choose Day</option>
        <option value =0>Monday</option>
        <option value =1>Tuesday</option>
        <option value =2>Wednesday</option>
        <option value =3>Thursday</option>
        <option value =4>Friday</option>
        <option value =5>Saturday</option>
        <option value =6>Sunday</option>
</select>
</div>
    <div id = "stationInfoBox"></div>
</div> 
    
<!--Hourly Chart-->
<div id = "hourlyChart">
    <div id="chartdiv"></div>
    <div id="curtain"><span></span></div>
</div>

</div>
<!-- Weather API -->   
<!--<div><a href="#" class="get_weather">Get weather</a></div>-->


<!-- Footer -->
<div id="footer">More info: <a href ="http://www.dublinbikes.ie/">DublinBikes.ie</a></div>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  
<!-- The Map -->
<script>
    function initMap() {
        var dublin = {lat: 53.346880, lng: -6.265615,};
        var map = new  google.maps.Map(document.getElementById('map'), {
          zoom: 13.6,
          center: dublin
        });
        
        var bikeLayer = new google.maps.BicyclingLayer();
        bikeLayer.setMap(map);
        
        var heatmapData = [];
        
        {% for Station in Stations %}
        
        var location = {lat: {{ Station.position.lat }}, lng: {{ Station.position.lng }},};
        var stationName = ' {{ Station.name }} ';
        var availablebikes = {{ Station.available_bikes }};
        var availablebikestands = {{ Station.available_bike_stands}};
        var stationNumber = '{{ Station.number}}';
        var address = '{{ Station.address }}';
        var totalBikes = availablebikes + availablebikestands;
        var infoString = 
            '<h4>' + address + '</h4>'+
            '<p> No. of Available Bikes : ' + availablebikes + '</p>' + 
            '<p> No. of Available Stands : ' + availablebikestands + '</p>' +
            '<p class="button button5" onclick="insertAddInfo(' + stationNumber + ');populateStationBox(' + availablebikes + ',' + availablebikestands + '); resetDropdown(); resetStation('+stationNumber+')">More Information</p>'
            ;
        var marker = new google.maps.Marker({
          position: location,
          draggable: false,
          map: map,
          contentString: infoString,    
          title: stationName,
          available: (availablebikes/totalBikes)
            });

    heatmapData.push(
    {location: new google.maps.LatLng({{ Station.position.lat }}, {{ Station.position.lng }}),
    weight: {{ Station.available_bikes }}
});
    
         var infowindow = new google.maps.InfoWindow({});
         marker.addListener('click', function() {
           infowindow.setContent(this.contentString);
           infowindow.open(map, this);
     });
          
        if (  marker.available >= 0.75) {
                marker.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png');
        }
        else if ( marker.available >= 0.5) {
                marker.setIcon('http://maps.google.com/mapfiles/ms/icons/yellow-dot.png');
            }
        else if ( marker.available >= 0.2) {
                marker.setIcon('http://maps.google.com/mapfiles/ms/icons/orange-dot.png');
            }
        else {
                marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');
            }
    
    
        {% endfor %}
        var icons = {
          green: {
            name: '> 75% Bikes Available',
            icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
          },
        yellow: {
            name: '50-75% Bikes Available',
            icon: 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png'
          },
            orange: {
            name: '25-50% Bikes Available',
            icon: 'http://maps.google.com/mapfiles/ms/icons/orange-dot.png'
          },
            red: {
            name: '< 25% Bikes Available',
            icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
          }
          
        };
        var icons2 = {
          trails: {
            name: '',
            icon: "../static/bike_trails.png"
          }
        };
        var legend = document.getElementById('legend');
        for (var key in icons) {
          var type = icons[key];
          var name = type.name;
          var icon = type.icon;
          var div = document.createElement('div');
          div.innerHTML = '<img src="' + icon + '"height="22" width="22"> ' + name;
          legend.appendChild(div);
        }
         
        var legend2 = document.getElementById('legend');
        for (var key in icons2) {
          var type = icons2[key];
          var name = type.name;
          var icon = type.icon;
          var div = document.createElement('div');
          div.innerHTML = '<img src="' + icon + '"> ' + name;
          legend.appendChild(div);
        }

        map.controls[google.maps.ControlPosition.RIGHT_TOP].push
(document.getElementById('legend'));
        }
    function resetStation(stationNumber){
        document.getElementById("myDropdown").value=stationNumber;
    }
        // some parts adapted from: https://stackoverflow.com/questions/30012913/google-map-api-v3-add-multiple-infowindows   
    
// the below was attempt at getting the heat map going
// the heatmapData is populating correctly but below doesnt work
        
//            document.getElementById('chart').innerHTML = heatmapData;
//            google.maps.event.addDomListener(map, 'zoom_changed', function() {
//            var zoom = map.getZoom();
//            if (zoom <= 15) {
//                heatmap = new google.maps.visualization.HeatmapLayer({
//                data: heatmapData,
//                map: map
//                });
//                heatmap.setMap(map);
//                heatmap.set('radius', 40);
//            };
//         
//         heatmap = new google.maps.visualization.HeatmapLayer({
//            data: heatmapData,
//            map: map
//            });
//        console.log(heatmap);
//        heatmap.setMap(map);
//        heatmap.set('radius', 40); 
//    };
//    
 
    
    function populateStationBox(bikes, stands){
        var boxInfo = 
            '<p> No. of Available Bikes : ' + bikes + '</p>' + 
            '<p> No. of Available Stands : ' + stands + '</p>' +
            '<p> Credit Card Terminal : Yes</p>' + 
            '<p> Leap Card Accepted : Yes';
            document.getElementById('stationInfoBox').innerHTML = boxInfo ;
        }
    
    function insertAddInfo(currentStation){
        chosenStation = currentStation;
        createChart(currentStation);
    }    
        
    function createChart(currentStation){
        var xmlhttp = new XMLHttpRequest();
        var url = "/available/" + currentStation;
        
        google.charts.load('current', {packages: ['corechart']});
        google.charts.setOnLoadCallback(drawWeeklyChart);
        console.log(url);
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                var data = JSON.parse(xmlhttp.response);
                console.log('data', data);
                drawWeeklyChart(data);
                }
            };
        xmlhttp.open("GET",url, true);
        xmlhttp.send();
        }
    </script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBRUrdJ4Tz9rLrHrOkwJWpA9QSYNJbWQ0Q&callback=initMap">
</script>
    
<!--The Dropdown-->
<script>
        var stations = [];
        var listItem = '<option value="" selected disabled hidden>Choose Station</option>';
        {% for Station in Static %}
        stations.push({
            key: '{{ Station.address }}',
            value: {{ Station.number }}});
            {% endfor %}
            stations = stations.sort(function (a, b) {
            return a.key.localeCompare( b.key );
            });
        //stations.sort(function(a,b) {return (a.key > b.key) ? 1 : ((b.key > a.key) ? -1 : 0);} );
        //stations.sort(key);
        for(i=0; i < stations.length; i++){
            listItem += '<option value='+ stations[i].value+'>' + stations[i].key + '</option>';
        }
        document.getElementById('myDropdown').innerHTML = listItem;
</script>
    
<!--Weekly Chart-->
<script type="text/javascript">
      function drawWeeklyChart(data) {
        var data = google.visualization.arrayToDataTable([
          ['Day', 'Number of Bikes Available'],
          ['Monday', data[0]["ROUND(AVG(available_bikes))"]],
          ['Tuesday',  data[1]["ROUND(AVG(available_bikes))"]],
          ['Wednesday',   data[2]["ROUND(AVG(available_bikes))"]],
          ['Thursday',  data[3]["ROUND(AVG(available_bikes))"]],
          ['Friday',  data[4]["ROUND(AVG(available_bikes))"]],
          ['Saturday',  data[5]["ROUND(AVG(available_bikes))"]],
          ['Sunday',  data[6]["ROUND(AVG(available_bikes))"]]
        ]);

        var options = {
          title: 'Daily Avg. Bike Availability',
          vAxis: {minValue: 0},
          legend: { position: 'bottom' }
        };

        var chart = new google.visualization.LineChart(document.getElementById('chart'));

        chart.draw(data, options);
      }
    </script>
    
<!--Hourly Chart-->
<script type="text/javascript">
        function resetDropdown() {
            var d = new Date();
            var n = d.getDay();
        document.getElementById("dayOfWeek").value=n-1;
        createHourlyChart(chosenStation, n-1);
        }   
        function insertAddHourlyInfo(day){
        
        createHourlyChart(chosenStation,day);
        };    
        function createHourlyChart(currentStation,day){
        var xmlhttp = new XMLHttpRequest();
        var url = "/hourly/" + currentStation + "/" + day;
        
        google.charts.load('current', {packages: ['corechart']});
        google.charts.setOnLoadCallback(drawHourlyChart);
        console.log(url);
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                var data = JSON.parse(xmlhttp.response);
                console.log('data', data);
                drawHourlyChart(data);
                }
            };
        xmlhttp.open("GET",url, true);
        xmlhttp.send();
        }
      function drawHourlyChart(data) {
        var data = google.visualization.arrayToDataTable([
             ['Time', 'Number of Bikes Available'],
             ['5am', data[0]["ROUND(AVG(available_bikes))"]],
             ['6am', data[1]["ROUND(AVG(available_bikes))"]],
             ['7am', data[2]["ROUND(AVG(available_bikes))"]],
             ['8am', data[3]["ROUND(AVG(available_bikes))"]],
             ['9am', data[4]["ROUND(AVG(available_bikes))"]],
             ['10am', data[5]["ROUND(AVG(available_bikes))"]],
             ['11am', data[6]["ROUND(AVG(available_bikes))"]],
             ['12pm', data[7]["ROUND(AVG(available_bikes))"]],
             ['1pm', data[8]["ROUND(AVG(available_bikes))"]],
             ['2pm', data[9]["ROUND(AVG(available_bikes))"]],
             ['3am', data[10]["ROUND(AVG(available_bikes))"]],
             ['4m', data[11]["ROUND(AVG(available_bikes))"]],
             ['5pm', data[12]["ROUND(AVG(available_bikes))"]],
             ['6pm', data[13]["ROUND(AVG(available_bikes))"]],
             ['7pm', data[14]["ROUND(AVG(available_bikes))"]],
             ['8pm', data[15]["ROUND(AVG(available_bikes))"]],
             ['9pm',data[16]["ROUND(AVG(available_bikes))"]],
             ['10pm', data[17]["ROUND(AVG(available_bikes))"]],
             ['11pm', data[18]["ROUND(AVG(available_bikes))"]]
        ]);

        var options = {
          title: 'Hourly Avg. Bike Availability',
          vAxis: {minValue: 0,
                 gridlines: {count:7}},
                 legend: { position: 'bottom' }
        };

        var chart = new google.visualization.LineChart(document.getElementById('hourlyChart'));
        chart.draw(data, options);
      }
    </script>


<!-- Weather API --> 
<script type="text/javascript">
    $( document ).ready(function() {
        console.log( "document loaded" );
        getWeather();
    });

    function getWeather(){
//call weather API from openweathermap
    var weatherdata;
    $.getJSON("http://api.openweathermap.org/data/2.5/weather?q=Dublin&id=7778677&APPID=2abe029b7b8d40e80d1ed447f4522f0d",function(data){
    var currentWeather = data.weather[0].description;
    var current_temp=data.main.temp;
    var wind_speed=data.wind.speed;
    var icon = data.weather[0].icon;
    var iconUrl = ("<img src='http://openweathermap.org/img/w/" + icon + ".png'>");
    
    $('h3#weather').html("Current Weather in Dublin");
    $('p#temp').html("Temperature: " + parseInt( + current_temp - 273.15) + " °C");
    $('p#humidity').html("Wind Speed: " + wind_speed + " m/s");
    $('p#wind').html(iconUrl);
    
})
}
</script>

</body>
</html>
